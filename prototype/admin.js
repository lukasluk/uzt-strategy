(() => {
const AUTH_STORAGE_KEY='uzt-strategy-v1-auth';
const DEFAULT_INSTITUTION_SLUG='uzt';
let root=null;
const IS_EMBEDDED_ADMIN=(()=>{const p=new URLSearchParams(window.location.search);return p.get('frame')==='admin'||window.self!==window.top;})();
const ADMIN_FRAME_HEIGHT_EVENT='uzt-admin-height';

const state={institutionSlug:resolveInstitutionSlug(),loading:false,busy:false,error:'',notice:'',adminTab:'cycle',token:null,user:null,role:null,context:null,cycle:null,participants:[],guidelines:[],initiatives:[],availableGuidelines:[],inviteToken:''};

hydrateAuthFromStorage();
if(IS_EMBEDDED_ADMIN)document.body.classList.add('embedded-admin');
setupEmbeddedHeightReporter();
mountAdminApp();

function resolveInstitutionSlug(){const p=new URLSearchParams(window.location.search);const q=normalizeSlug(p.get('institution'));if(q)return q;const parts=window.location.pathname.split('/').filter(Boolean);if(!parts.length)return DEFAULT_INSTITUTION_SLUG;const last=parts[parts.length-1];if(last==='admin.html'||last==='index.html')return normalizeSlug(parts[parts.length-2])||DEFAULT_INSTITUTION_SLUG;return normalizeSlug(last)||DEFAULT_INSTITUTION_SLUG;}
function normalizeSlug(v){const s=String(v||'').trim().toLowerCase();return s&&/^[a-z0-9-]+$/.test(s)?s:'';}
function mountAdminApp(options={}){const nextRoot=options.root||document.getElementById('adminRoot');if(!nextRoot)return false;root=nextRoot;const nextSlug=normalizeSlug(options.institutionSlug);if(nextSlug&&nextSlug!==state.institutionSlug){state.institutionSlug=nextSlug;state.error='';state.notice='';state.context=null;state.cycle=null;state.participants=[];state.guidelines=[];state.initiatives=[];state.availableGuidelines=[];state.inviteToken='';}if(options.forceAuthSync)hydrateAuthFromStorage();bootstrap();return true;}
window.DigiAdminApp={mount:mountAdminApp};

function hydrateAuthFromStorage(){const raw=localStorage.getItem(AUTH_STORAGE_KEY);if(!raw)return;try{const p=JSON.parse(raw);if(!p?.token)return;const slug=normalizeSlug(p.slug||p.homeSlug);if(slug&&slug!==state.institutionSlug)return;state.token=p.token;state.user=p.user||null;state.role=p.role||null;}catch{localStorage.removeItem(AUTH_STORAGE_KEY);}}
function persistAuthToStorage(){if(!state.token){localStorage.removeItem(AUTH_STORAGE_KEY);return;}localStorage.setItem(AUTH_STORAGE_KEY,JSON.stringify({slug:state.institutionSlug,homeSlug:state.institutionSlug,token:state.token,user:state.user,role:state.role}));}
function clearSession(){state.token=null;state.user=null;state.role=null;state.context=null;state.cycle=null;localStorage.removeItem(AUTH_STORAGE_KEY);window.dispatchEvent(new CustomEvent('uzt-auth-changed'));}
function setSession(payload){state.token=payload.token||null;state.user=payload.user||null;state.role=payload.role||null;persistAuthToStorage();window.dispatchEvent(new CustomEvent('uzt-auth-changed'));}

let resizeRaf=0;let resizeTimer=0;
function postEmbeddedHeight(){if(!IS_EMBEDDED_ADMIN)return;const b=document.body;const d=document.documentElement;const h=Math.max(Number(b?.scrollHeight||0),Number(b?.offsetHeight||0),Number(d?.scrollHeight||0),Number(d?.offsetHeight||0));window.parent.postMessage({type:ADMIN_FRAME_HEIGHT_EVENT,height:h},'*');}
function queueEmbeddedHeightPost(){if(!IS_EMBEDDED_ADMIN)return;if(resizeRaf)window.cancelAnimationFrame(resizeRaf);resizeRaf=window.requestAnimationFrame(()=>{resizeRaf=0;postEmbeddedHeight();});}
function setupEmbeddedHeightReporter(){if(!IS_EMBEDDED_ADMIN)return;window.addEventListener('load',queueEmbeddedHeightPost);window.addEventListener('resize',queueEmbeddedHeightPost);if(document.body){const mo=new MutationObserver(queueEmbeddedHeightPost);mo.observe(document.body,{childList:true,subtree:true,attributes:true});}if(resizeTimer)window.clearInterval(resizeTimer);resizeTimer=window.setInterval(queueEmbeddedHeightPost,900);}

function escapeHtml(v){return String(v||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');}
function formatDateTime(v){if(!v)return'Data nenurodyta';const d=new Date(v);if(Number.isNaN(d.getTime()))return'Data nenurodyta';return new Intl.DateTimeFormat('lt-LT',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d);}
function toUserMessage(error){const raw=String(error?.message||error||'').trim();const map={unauthorized:'Reikia prisijungti kaip institucijos administratorius.','invalid token':'Sesija nebegalioja. Prisijunkite iš naujo.','institution not found':`Institucija "${state.institutionSlug}" nerasta.`,'cycle not found':'Aktyvus ciklas nerastas.',forbidden:'Veiksmas neleidžiamas.','admin role required':'Reikalingos administratoriaus teisės.','cross-institution forbidden':'Prieiga prie kitos institucijos duomenų neleidžiama.','invalid credentials':'Neteisingi prisijungimo duomenys.','email required':'Nurodykite el. paštą.','userId and password(min 8) required':'Slaptažodis turi būti bent 8 simbolių.','cannot delete self':'Negalite ištrinti savo paskyros.','membership not found':'Narystė nerasta.','invalid relation type':'Netinkamas gairės ryšio tipas.','parent guideline required for child':'Vaikinei gairei būtina parinkti tėvinę gairę.','parent guideline not found':'Tėvinė gairė nerasta.','parent must be in same cycle':'Tėvinė gairė turi būti tame pačiame cikle.','child cannot be parent of itself':'Gairė negali būti pati sau tėvinė.','parent guideline must be parent':'Pasirinkta gairė nėra tėvinė.','cannot demote parent with children':'Negalima keisti tėvinės gairės tipo, kol ji turi vaikinių gairių.','guideline not found':'Gairė nerasta.','initiative not found':'Iniciatyva nerasta.','comment not found':'Komentaras nerastas.','guideline not in cycle':'Pasirinkta gairė nepriklauso šiam ciklui.','at least one guideline required':'Iniciatyva turi būti priskirta bent vienai gairei.'};return map[raw]||raw||'Nepavyko įvykdyti užklausos.';}

async function api(path,{method='GET',body=null,auth=true}={}){const headers={};if(body!==null)headers['Content-Type']='application/json';if(auth){if(!state.token)throw new Error('unauthorized');headers.Authorization=`Bearer ${state.token}`;}const r=await fetch(path,{method,headers,body:body!==null?JSON.stringify(body):undefined});const raw=await r.text();let payload=null;if(raw){try{payload=JSON.parse(raw);}catch{payload=null;}}if(!r.ok)throw new Error(payload?.error||`HTTP ${r.status}`);return payload||{};}

async function loadContext(){const c=await api('/api/v1/me/context');if(!c?.institution?.slug)throw new Error('Nepavyko gauti konteksto.');if(c.institution.slug!==state.institutionSlug){clearSession();throw new Error(`Prisijungimas priklauso institucijai "${c.institution.slug}".`);}if(c.membership?.role!=='institution_admin')throw new Error('admin role required');state.context=c;state.cycle=c.cycle||null;state.user=state.user||c.user||null;state.role=c.membership?.role||'member';}

async function loadAdminData(){if(!state.cycle?.id){state.participants=[];state.guidelines=[];state.initiatives=[];state.availableGuidelines=[];return;}const [pp,gp,ip]=await Promise.all([api(`/api/v1/admin/cycles/${encodeURIComponent(state.cycle.id)}/participants`),api(`/api/v1/admin/cycles/${encodeURIComponent(state.cycle.id)}/guidelines`),api(`/api/v1/admin/cycles/${encodeURIComponent(state.cycle.id)}/initiatives`)]);state.participants=Array.isArray(pp.participants)?pp.participants:[];state.guidelines=Array.isArray(gp.guidelines)?gp.guidelines:[];state.initiatives=Array.isArray(ip.initiatives)?ip.initiatives:[];state.availableGuidelines=Array.isArray(ip.guidelines)?ip.guidelines:state.guidelines.map(g=>({id:g.id,title:g.title,status:g.status}));}

async function bootstrap(){root=root||document.getElementById('adminRoot');if(!root)return;if(!state.token){render();return;}state.loading=true;state.error='';render();try{await loadContext();await loadAdminData();}catch(error){state.error=toUserMessage(error);if(String(error?.message||'')==='invalid token'||String(error?.message||'')==='unauthorized')clearSession();}finally{state.loading=false;render();}}
async function runBusy(task){if(state.busy)return;state.busy=true;state.notice='';render();try{await task();}catch(error){state.notice=toUserMessage(error);}finally{state.busy=false;render();}}

function selectedValues(selectElement){if(!(selectElement instanceof HTMLSelectElement))return[];return Array.from(selectElement.options).filter(o=>o.selected).map(o=>String(o.value||'').trim()).filter(Boolean);}
function guidelineOptions(selectedIds){const sel=new Set(Array.isArray(selectedIds)?selectedIds.map(String):[]);return state.availableGuidelines.map(g=>`<option value="${escapeHtml(g.id)}" ${sel.has(String(g.id))?'selected':''}>${escapeHtml(g.title||g.id)}</option>`).join('');}

function renderLogin(){const back=IS_EMBEDDED_ADMIN?'':`<p class="prompt" style="margin-top:12px;">Narys? Grįžkite į viešą puslapį: <a href="index.html?institution=${encodeURIComponent(state.institutionSlug)}">index</a></p>`;root.innerHTML=`<section class="card" style="max-width:560px;margin:30px auto;"><h2 style="font-family:'Fraunces',serif;">Admin prisijungimas</h2><p class="prompt">Prisijunkite kaip institucijos administratorius.</p><p class="prompt">Institucija: <strong>${escapeHtml(state.institutionSlug)}</strong></p><div id="loginError" class="error" style="display:none;"></div><form id="adminLoginForm" class="login-form"><input type="text" name="email" placeholder="El. paštas" required /><input type="password" name="password" placeholder="Slaptažodis" required /><button type="submit" class="btn btn-primary">Prisijungti</button></form>${back}</section>`;const form=document.getElementById('adminLoginForm');const loginError=document.getElementById('loginError');form.addEventListener('submit',async(e)=>{e.preventDefault();const fd=new FormData(form);const email=String(fd.get('email')||'').trim();const password=String(fd.get('password')||'');if(!email||!password)return;try{const payload=await api('/api/v1/auth/login',{method:'POST',auth:false,body:{email,password,institutionSlug:state.institutionSlug}});setSession(payload);await bootstrap();}catch(error){loginError.style.display='block';loginError.textContent=toUserMessage(error);}});}
function flatComments(items,kind){const out=[];(items||[]).forEach(item=>{const comments=Array.isArray(item.comments)?item.comments:[];comments.forEach(c=>out.push({...c,kind,entityId:item.id,entityTitle:item.title||'-'}));});return out;}

function renderCardCommentModeration(comments,kind){
  const safeComments=Array.isArray(comments)?comments:[];
  const title=kind==='initiative'?'Komentarų moderavimas (iniciatyva)':'Komentarų moderavimas (gairė)';
  if(!safeComments.length)return `<section class="admin-comment-box"><div class="header-row"><strong>${title}</strong><span class="tag">0</span></div><p class="prompt">Komentarų dar nėra.</p></section>`;
  return `<section class="admin-comment-box"><div class="header-row"><strong>${title}</strong><span class="tag">${safeComments.length}</span></div><ul class="mini-list admin-comment-list">${safeComments.map(comment=>{const st=String(comment?.status||'visible').toLowerCase()==='hidden'?'hidden':'visible';const next=st==='hidden'?'visible':'hidden';const txt=st==='hidden'?'Rodyti':'Slėpti';const author=String(comment?.authorName||comment?.authorEmail||'Nežinomas autorius').trim();return `<li class="admin-comment-item ${st==='hidden'?'is-hidden':''}"><div class="admin-global-comment-head"><span class="tag">${escapeHtml(st)}</span><span class="tag">${escapeHtml(formatDateTime(comment?.createdAt))}</span></div><div class="admin-comment-body">${escapeHtml(comment?.body||'')}</div><div class="admin-comment-meta">${escapeHtml(author)}</div><div class="admin-comment-actions"><button type="button" class="btn btn-ghost comment-status-btn" data-comment-kind="${kind}" data-comment-id="${escapeHtml(comment?.id)}" data-next-status="${next}" ${state.busy?'disabled':''}>${txt}</button></div></li>`;}).join('')}</ul></section>`;
}
function renderGuidelineCards(){
  return state.guidelines.map(g=>{const relation=String(g.relationType||'orphan');const comments=Array.isArray(g.comments)?g.comments:[];const parentOptions=state.guidelines.filter(c=>c.id!==g.id&&c.relationType==='parent').map(c=>`<option value="${escapeHtml(c.id)}" ${c.id===g.parentGuidelineId?'selected':''}>${escapeHtml(c.title)}</option>`).join('');return `<article class="card ${g.status==='active'?'':'admin-panel'}"><form class="admin-guideline-form admin-edit-form" data-id="${escapeHtml(g.id)}"><input class="admin-edit-title" type="text" name="title" value="${escapeHtml(g.title)}" required ${state.busy?'disabled':''}/><textarea class="admin-edit-description" name="description" placeholder="Aprašymas" ${state.busy?'disabled':''}>${escapeHtml(g.description||'')}</textarea><div class="admin-edit-grid"><select name="status" ${state.busy?'disabled':''}>${['active','disabled','merged','hidden'].map(i=>`<option value="${i}" ${i===g.status?'selected':''}>${i}</option>`).join('')}</select><select name="relationType" ${state.busy?'disabled':''}><option value="orphan" ${relation==='orphan'?'selected':''}>Našlaitė</option><option value="parent" ${relation==='parent'?'selected':''}>Tėvinė</option><option value="child" ${relation==='child'?'selected':''}>Vaikinė</option></select><select name="lineSide" ${state.busy?'disabled':''}><option value="auto" ${(g.lineSide||'auto')==='auto'?'selected':''}>Linija: auto</option><option value="left" ${g.lineSide==='left'?'selected':''}>Linija: kairė</option><option value="right" ${g.lineSide==='right'?'selected':''}>Linija: dešinė</option><option value="top" ${g.lineSide==='top'?'selected':''}>Linija: viršus</option><option value="bottom" ${g.lineSide==='bottom'?'selected':''}>Linija: apačia</option></select><select name="parentGuidelineId" ${state.busy?'disabled':''} ${relation==='child'?'':'disabled'}><option value="">Pasirinkite tėvinę gairę</option>${parentOptions}</select></div><div class="admin-edit-actions"><button class="btn btn-primary" type="submit" ${state.busy?'disabled':''}>Išsaugoti</button><button class="btn btn-danger guideline-delete-btn" type="button" data-guideline-id="${escapeHtml(g.id)}" data-guideline-title="${escapeHtml(g.title)}" ${state.busy?'disabled':''}>Ištrinti</button></div><div class="header-stack"><span class="tag">Balas: ${Number(g.totalScore||0)}</span><span class="tag">Balsuotojai: ${Number(g.voterCount||0)}</span><span class="tag">Komentarai: ${comments.length}</span><span class="tag">Ryšys: ${escapeHtml(relation)}</span></div>${renderCardCommentModeration(comments,'guideline')}</form></article>`;}).join('');
}
function renderInitiativeCards(){
  return state.initiatives.map(i=>{const selected=Array.isArray(i.guidelineIds)?i.guidelineIds:(Array.isArray(i.guidelineLinks)?i.guidelineLinks.map(x=>x.guidelineId):[]);const comments=Array.isArray(i.comments)?i.comments:[];return `<article class="card ${i.status==='active'?'':'admin-panel'}"><form class="admin-initiative-form admin-edit-form" data-id="${escapeHtml(i.id)}"><input class="admin-edit-title" type="text" name="title" value="${escapeHtml(i.title)}" required ${state.busy?'disabled':''}/><textarea class="admin-edit-description" name="description" placeholder="Aprašymas" ${state.busy?'disabled':''}>${escapeHtml(i.description||'')}</textarea><div class="admin-edit-grid admin-edit-grid-initiative"><select name="status" ${state.busy?'disabled':''}>${['active','disabled','merged','hidden'].map(s=>`<option value="${s}" ${s===i.status?'selected':''}>${s}</option>`).join('')}</select><select name="lineSide" ${state.busy?'disabled':''}><option value="auto" ${(i.lineSide||'auto')==='auto'?'selected':''}>Linija: auto</option><option value="left" ${i.lineSide==='left'?'selected':''}>Linija: kairė</option><option value="right" ${i.lineSide==='right'?'selected':''}>Linija: dešinė</option><option value="top" ${i.lineSide==='top'?'selected':''}>Linija: viršus</option><option value="bottom" ${i.lineSide==='bottom'?'selected':''}>Linija: apačia</option></select></div><label class="prompt admin-edit-label">Priskirtos gairės (bent 1)</label><select name="guidelineIds" multiple size="${Math.min(Math.max(state.availableGuidelines.length,4),10)}" ${state.busy?'disabled':''}>${guidelineOptions(selected)}</select><div class="admin-edit-actions"><button class="btn btn-primary" type="submit" ${state.busy?'disabled':''}>Išsaugoti</button><button class="btn btn-danger initiative-delete-btn" type="button" data-initiative-id="${escapeHtml(i.id)}" data-initiative-title="${escapeHtml(i.title)}" ${state.busy?'disabled':''}>Ištrinti</button></div><div class="header-stack"><span class="tag">Balas: ${Number(i.totalScore||0)}</span><span class="tag">Balsuotojai: ${Number(i.voterCount||0)}</span><span class="tag">Komentarai: ${comments.length}</span></div>${renderCardCommentModeration(comments,'initiative')}</form></article>`;}).join('');
}
function renderDashboard(){const cycle=state.cycle;const resultsPublished=Boolean(cycle?.results_published);const cycleState=String(cycle?.state||'open');root.innerHTML=`${state.error?`<section class="card" style="margin-bottom:16px;"><strong>Klaida</strong><p class="prompt">${escapeHtml(state.error)}</p><button id="retryBtn" class="btn btn-primary">Bandyti dar kartą</button></section>`:''}${state.notice?`<section class="card" style="margin-bottom:16px;"><strong>${escapeHtml(state.notice)}</strong></section>`:''}<section class="card admin-tabs-card" style="margin-bottom:16px;"><div class="admin-tabs"><button type="button" class="admin-tab-btn ${state.adminTab==='cycle'?'active':''}" data-admin-tab="cycle">Ciklas</button><button type="button" class="admin-tab-btn ${state.adminTab==='users'?'active':''}" data-admin-tab="users">Vartotojai</button><button type="button" class="admin-tab-btn ${state.adminTab==='guidelines'?'active':''}" data-admin-tab="guidelines">Gairės</button><button type="button" class="admin-tab-btn ${state.adminTab==='initiatives'?'active':''}" data-admin-tab="initiatives">Iniciatyvos</button></div></section><section class="card" data-admin-section="cycle" style="margin-bottom:16px;"><div class="header-row"><strong>Ciklo valdymas</strong><span class="tag">ID: ${escapeHtml(cycle?.id||'-')}</span></div><p class="prompt">Būsena valdo, ar nariai gali balsuoti ir komentuoti (OPEN). Uždarius ciklą (CLOSED), balsavimas ir komentavimas išjungiami.</p><div class="inline-form"><select id="cycleStateSelect" ${state.busy||!cycle?.id?'disabled':''}>${['open','closed'].map(i=>`<option value="${i}" ${i===cycleState?'selected':''}>${i.toUpperCase()}</option>`).join('')}</select><button id="saveCycleStateBtn" class="btn btn-primary" ${state.busy||!cycle?.id?'disabled':''}>Atnaujinti būseną</button></div><div class="header-row" style="margin-top:12px;"><span class="tag ${resultsPublished?'tag-main':''}">${resultsPublished?'Rezultatai vieši':'Rezultatai nevieši'}</span><button id="toggleResultsBtn" class="btn btn-primary" ${state.busy||!cycle?.id?'disabled':''}>${resultsPublished?'Paslėpti rezultatus':'Paskelbti rezultatus'}</button></div></section><section class="card" data-admin-section="users" style="margin-bottom:16px;"><div class="header-row"><strong>Kvietimai nariams</strong><span class="tag">Invite-only</span></div><form id="inviteForm" class="inline-form"><input type="text" name="email" placeholder="Nario el. paštas" required ${state.busy?'disabled':''}/><button type="submit" class="btn btn-primary" ${state.busy?'disabled':''}>Sukurti kvietimą</button></form>${state.inviteToken?`<div class="card" style="margin-top:12px;"><strong>Naujas kvietimo žetonas</strong><p class="prompt" style="word-break:break-all;">${escapeHtml(state.inviteToken)}</p><button id="copyInviteTokenBtn" class="btn btn-ghost">Kopijuoti žetoną</button></div>`:''}</section><section class="card" data-admin-section="users" style="margin-bottom:16px;"><div class="header-row"><strong>Dalyviai</strong><span class="tag">${state.participants.length}</span></div><ul class="mini-list">${state.participants.length?state.participants.map(p=>`<li><div class="header-row" style="align-items:flex-start;gap:8px;"><div><strong>${escapeHtml(p.display_name||p.email)}</strong><div class="prompt" style="margin-top:4px;">El. paštas: ${escapeHtml(p.email||'-')}</div></div><div class="header-stack" style="margin-left:auto;"><span class="muted">${p.has_voted?'Balsavo':'Nebalsavo'}</span><span class="tag">Taškai: ${Number(p.total_score||0)}</span></div></div><div class="inline-form" style="margin-top:8px;"><form class="participant-password-form inline-form" data-user-id="${escapeHtml(p.id)}"><input type="password" name="password" placeholder="Naujas slaptažodis (min. 8)" minlength="8" required ${state.busy?'disabled':''}/><button type="submit" class="btn btn-ghost" ${state.busy?'disabled':''}>Atnaujinti slaptažodį</button></form><button type="button" class="btn btn-ghost participant-delete-btn" data-user-id="${escapeHtml(p.id)}" data-name="${escapeHtml(p.display_name||p.email||'vartotojas')}" ${state.busy?'disabled':''}>Ištrinti vartotoją</button></div></li>`).join(''):'<li>Nėra dalyvių.</li>'}</ul></section><section class="card" data-admin-section="guidelines" style="margin-bottom:16px;"><div class="header-row"><strong>Pridėti gaires</strong><span class="tag">${state.guidelines.length} viso</span></div><form id="addGuidelineForm" class="admin-add-form"><div class="form-row"><input type="text" name="title" placeholder="Gairės pavadinimas" required ${state.busy||!cycle?.id?'disabled':''}/></div><textarea class="admin-edit-description" name="description" placeholder="Trumpas paaiškinimas" ${state.busy||!cycle?.id?'disabled':''}></textarea><button class="btn btn-primary" type="submit" style="margin-top:12px;" ${state.busy||!cycle?.id?'disabled':''}>Pridėti gairę</button></form></section><section class="card" data-admin-section="guidelines" style="margin-bottom:16px;"><div class="header-row"><strong>Gairių redagavimas ir komentarų moderavimas</strong><span class="tag">${state.guidelines.length}</span></div><div class="card-list admin-guideline-grid">${renderGuidelineCards()}</div></section><section class="card" data-admin-section="initiatives" style="margin-bottom:16px;"><div class="header-row"><strong>Pridėti iniciatyvą</strong><span class="tag">${state.initiatives.length} viso</span></div><form id="addInitiativeForm" class="admin-add-form"><div class="form-row"><input type="text" name="title" placeholder="Iniciatyvos pavadinimas" required ${state.busy||!cycle?.id?'disabled':''}/></div><textarea class="admin-edit-description" name="description" placeholder="Trumpas paaiškinimas" ${state.busy||!cycle?.id?'disabled':''}></textarea><label class="prompt" style="display:block;margin:8px 0 6px;">Priskirtos gairės (bent 1)</label><select name="guidelineIds" multiple size="${Math.min(Math.max(state.availableGuidelines.length,4),10)}" ${state.busy||!cycle?.id?'disabled':''}>${guidelineOptions([])}</select><div class="inline-form" style="margin-top:12px;"><select name="lineSide" ${state.busy||!cycle?.id?'disabled':''}><option value="auto">Linija: auto</option><option value="left">Linija: kairė</option><option value="right">Linija: dešinė</option><option value="top">Linija: viršus</option><option value="bottom">Linija: apačia</option></select><button class="btn btn-primary" type="submit" ${state.busy||!cycle?.id?'disabled':''}>Pridėti iniciatyvą</button></div></form></section><section class="card" data-admin-section="initiatives" style="margin-bottom:16px;"><div class="header-row"><strong>Iniciatyvų redagavimas ir komentarų moderavimas</strong><span class="tag">${state.initiatives.length}</span></div><div class="card-list admin-guideline-grid admin-initiative-grid">${renderInitiativeCards()}</div></section>`;applyTabVisibility();bindDashboardEvents();}
function applyTabVisibility(){const allowed=['cycle','users','guidelines','initiatives'];const active=allowed.includes(state.adminTab)?state.adminTab:'cycle';state.adminTab=active;root.querySelectorAll('[data-admin-section]').forEach(sec=>{const show=sec.dataset.adminSection===active;sec.hidden=!show;sec.style.display=show?'':'none';});}

function bindDashboardEvents(){root.querySelectorAll('[data-admin-tab]').forEach(btn=>{btn.addEventListener('click',()=>{const next=String(btn.dataset.adminTab||'').trim();if(!['cycle','users','guidelines','initiatives'].includes(next)||next===state.adminTab)return;state.adminTab=next;render();});});
const retryBtn=document.getElementById('retryBtn');if(retryBtn)retryBtn.addEventListener('click',bootstrap);
const saveCycleStateBtn=document.getElementById('saveCycleStateBtn');if(saveCycleStateBtn){saveCycleStateBtn.addEventListener('click',async()=>{const select=document.getElementById('cycleStateSelect');const nextState=String(select?.value||'').trim();if(!nextState||!state.cycle?.id)return;await runBusy(async()=>{await api(`/api/v1/admin/cycles/${encodeURIComponent(state.cycle.id)}/state`,{method:'PUT',body:{state:nextState}});await bootstrap();});});}
const toggleResultsBtn=document.getElementById('toggleResultsBtn');if(toggleResultsBtn){toggleResultsBtn.addEventListener('click',async()=>{if(!state.cycle?.id)return;await runBusy(async()=>{await api(`/api/v1/admin/cycles/${encodeURIComponent(state.cycle.id)}/results`,{method:'POST',body:{published:!Boolean(state.cycle?.results_published)}});await bootstrap();});});}
const inviteForm=document.getElementById('inviteForm');if(inviteForm){inviteForm.addEventListener('submit',async e=>{e.preventDefault();const email=String(new FormData(inviteForm).get('email')||'').trim();if(!email)return;await runBusy(async()=>{const payload=await api('/api/v1/admin/invites',{method:'POST',body:{email,role:'member'}});state.inviteToken=String(payload.inviteToken||'');});});}
const copyInviteTokenBtn=document.getElementById('copyInviteTokenBtn');if(copyInviteTokenBtn){copyInviteTokenBtn.addEventListener('click',async()=>{if(!state.inviteToken)return;await navigator.clipboard.writeText(state.inviteToken);state.notice='Kvietimo žetonas nukopijuotas.';render();});}
const addGuidelineForm=document.getElementById('addGuidelineForm');if(addGuidelineForm){addGuidelineForm.addEventListener('submit',async e=>{e.preventDefault();if(!state.cycle?.id)return;const fd=new FormData(addGuidelineForm);const title=String(fd.get('title')||'').trim();const description=String(fd.get('description')||'').trim();if(!title)return;await runBusy(async()=>{await api(`/api/v1/cycles/${encodeURIComponent(state.cycle.id)}/guidelines`,{method:'POST',body:{title,description}});await bootstrap();});});}
const addInitiativeForm=document.getElementById('addInitiativeForm');if(addInitiativeForm){addInitiativeForm.addEventListener('submit',async e=>{e.preventDefault();if(!state.cycle?.id)return;const fd=new FormData(addInitiativeForm);const title=String(fd.get('title')||'').trim();const description=String(fd.get('description')||'').trim();const lineSide=String(fd.get('lineSide')||'auto').trim();const guidelineIds=selectedValues(addInitiativeForm.querySelector('select[name="guidelineIds"]'));if(!title)return;await runBusy(async()=>{await api(`/api/v1/cycles/${encodeURIComponent(state.cycle.id)}/initiatives`,{method:'POST',body:{title,description,lineSide,guidelineIds}});await bootstrap();});});}
root.querySelectorAll('.admin-guideline-form').forEach(form=>{const relationSelect=form.querySelector('[name="relationType"]');const parentSelect=form.querySelector('[name="parentGuidelineId"]');if(relationSelect&&parentSelect){const sync=()=>{const rel=String(relationSelect.value||'orphan');const needs=rel==='child';parentSelect.disabled=state.busy||!needs;if(!needs)parentSelect.value='';};relationSelect.addEventListener('change',sync);sync();}form.addEventListener('submit',async e=>{e.preventDefault();const guidelineId=form.dataset.id;if(!guidelineId)return;const fd=new FormData(form);const title=String(fd.get('title')||'').trim();const description=String(fd.get('description')||'').trim();const status=String(fd.get('status')||'active').trim();const relationType=String(fd.get('relationType')||'orphan').trim();const parentGuidelineId=String(fd.get('parentGuidelineId')||'').trim();const lineSide=String(fd.get('lineSide')||'auto').trim().toLowerCase();if(!title)return;await runBusy(async()=>{await api(`/api/v1/admin/guidelines/${encodeURIComponent(guidelineId)}`,{method:'PUT',body:{title,description,status,relationType,lineSide,parentGuidelineId:relationType==='child'?parentGuidelineId:null}});await bootstrap();});});});
root.querySelectorAll('.admin-initiative-form').forEach(form=>{form.addEventListener('submit',async e=>{e.preventDefault();const initiativeId=String(form.dataset.id||'').trim();if(!initiativeId)return;const fd=new FormData(form);const title=String(fd.get('title')||'').trim();const description=String(fd.get('description')||'').trim();const status=String(fd.get('status')||'active').trim();const lineSide=String(fd.get('lineSide')||'auto').trim().toLowerCase();const guidelineIds=selectedValues(form.querySelector('select[name="guidelineIds"]'));if(!title)return;await runBusy(async()=>{await api(`/api/v1/admin/initiatives/${encodeURIComponent(initiativeId)}`,{method:'PUT',body:{title,description,status,lineSide,guidelineIds}});await bootstrap();});});});
root.querySelectorAll('.guideline-delete-btn').forEach(button=>{button.addEventListener('click',async()=>{const guidelineId=String(button.dataset.guidelineId||'').trim();const title=String(button.dataset.guidelineTitle||'ši gairė');if(!guidelineId)return;if(!window.confirm(`Ar tikrai norite ištrinti gairę "${title}"?`))return;await runBusy(async()=>{await api(`/api/v1/admin/guidelines/${encodeURIComponent(guidelineId)}`,{method:'DELETE'});state.notice='Gairė ištrinta.';await bootstrap();});});});
root.querySelectorAll('.initiative-delete-btn').forEach(button=>{button.addEventListener('click',async()=>{const initiativeId=String(button.dataset.initiativeId||'').trim();const title=String(button.dataset.initiativeTitle||'ši iniciatyva');if(!initiativeId)return;if(!window.confirm(`Ar tikrai norite ištrinti iniciatyvą "${title}"?`))return;await runBusy(async()=>{await api(`/api/v1/admin/initiatives/${encodeURIComponent(initiativeId)}`,{method:'DELETE'});state.notice='Iniciatyva ištrinta.';await bootstrap();});});});
root.querySelectorAll('.comment-status-btn').forEach(button=>{button.addEventListener('click',async()=>{const commentId=String(button.dataset.commentId||'').trim();const nextStatus=String(button.dataset.nextStatus||'').trim().toLowerCase();const kind=String(button.dataset.commentKind||'guideline').trim().toLowerCase();if(!commentId||!['visible','hidden'].includes(nextStatus))return;const path=kind==='initiative'?`/api/v1/admin/initiative-comments/${encodeURIComponent(commentId)}/status`:`/api/v1/admin/comments/${encodeURIComponent(commentId)}/status`;await runBusy(async()=>{await api(path,{method:'PUT',body:{status:nextStatus}});state.notice=nextStatus==='hidden'?'Komentaras paslėptas.':'Komentaras vėl rodomas.';await bootstrap();});});});
root.querySelectorAll('.participant-password-form').forEach(form=>{form.addEventListener('submit',async e=>{e.preventDefault();const userId=String(form.dataset.userId||'').trim();const password=String(new FormData(form).get('password')||'');if(!userId||password.length<8)return;await runBusy(async()=>{await api(`/api/v1/admin/users/${encodeURIComponent(userId)}/password`,{method:'PUT',body:{password}});state.notice='Slaptažodis atnaujintas.';});});});
root.querySelectorAll('.participant-delete-btn').forEach(button=>{button.addEventListener('click',async()=>{const userId=String(button.dataset.userId||'').trim();const name=String(button.dataset.name||'vartotojas');if(!userId)return;if(!window.confirm(`Ar tikrai norite ištrinti vartotoją: ${name}?`))return;await runBusy(async()=>{await api(`/api/v1/admin/users/${encodeURIComponent(userId)}`,{method:'DELETE'});await bootstrap();});});});}

function render(){if(!root)return;if(!state.token){renderLogin();queueEmbeddedHeightPost();return;}if(state.loading){root.innerHTML='<section class="card"><strong>Kraunami administravimo duomenys...</strong></section>';queueEmbeddedHeightPost();return;}if(state.error&&!state.context){root.innerHTML=`<section class="card"><strong>Prieiga negauta</strong><p class="prompt">${escapeHtml(state.error)}</p><button id="clearSessionBtn" class="btn btn-ghost">Atsijungti</button></section>`;const clearBtn=document.getElementById('clearSessionBtn');if(clearBtn){clearBtn.addEventListener('click',()=>{clearSession();render();});}queueEmbeddedHeightPost();return;}renderDashboard();queueEmbeddedHeightPost();}
})();



